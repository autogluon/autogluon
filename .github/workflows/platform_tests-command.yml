name: Platform Tests
on:
  schedule:
    - cron: '59 07 * * *'  #  UTC 7:59(23:59 PST Winter Time) everyday
  workflow_dispatch:

jobs:
  tabular:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        os: [macos-latest]
    steps:
      - name: Checkout repository for PR
        if: (github.event_name == 'workflow_dispatch')
        uses: actions/checkout@v2
      - name: Checkout repository for nightly test
        if: (github.event_name == 'schedule')
        uses: actions/checkout@v2
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2.0.0
        with:
          activate-environment: autogluon_py3
          environment-file: .github/workflows_env/unittest_env.yml
          auto-update-conda: true
          python-version: 3.8
      - name: Setup OMP
        if: matrix.os == 'macos-latest'
        shell: bash -l {0}
        run: |
          wget https://raw.githubusercontent.com/Homebrew/homebrew-core/fb8323f2b170bd4ae97e1bac9bf3e2983af3fdb0/Formula/libomp.rb
          brew install libomp.rb
          rm libomp.rb
      - name: unit-test
        shell: bash -l {0}
        run: |
          python3 -m pip install --upgrade "mxnet<2.0.0"
          python3 -m pip install --upgrade -e common/[tests]
          python3 -m pip install --upgrade -e core/[all]
          python3 -m pip install --upgrade -e features/
          python3 -m pip install --upgrade -e tabular/[all,tests]
          env
          cd tabular/
          python3 -m pytest --junitxml=results.xml --runslow -m "not gpu" tests
