name: Continuous Integration

on:
  push:
    branches:
    - master
  pull_request_target:

defaults:
  run:
    shell: bash

jobs:
  test_common:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Common on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Common-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_common.sh && ./.github/workflow_scripts/test_common.sh" \
                                          --wait
      - name: Test Common on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Common-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_common.sh && ./.github/workflow_scripts/test_common.sh" \
                                          --wait
  test_core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Core on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Core-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_core.sh && ./.github/workflow_scripts/test_core.sh" \
                                          --wait
      - name: Test Core on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Core-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_core.sh && ./.github/workflow_scripts/test_core.sh" \
                                          --wait
  test_features:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Features on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Features-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_features.sh && ./.github/workflow_scripts/test_features.sh" \
                                          --wait
      - name: Test Features on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Features-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_features.sh && ./.github/workflow_scripts/test_features.sh" \
                                          --wait
  test_tabular:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Tabular on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Tabular-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_tabular.sh && ./.github/workflow_scripts/test_tabular.sh" \
                                          --wait
      - name: Test Tabular on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Tabular-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_tabular.sh && ./.github/workflow_scripts/test_tabular.sh" \
                                          --wait
  test_text:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Text on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Text-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_text.sh && ./.github/workflow_scripts/test_text.sh" \
                                          --wait
      - name: Test Text on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Text-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_text.sh && ./.github/workflow_scripts/test_text.sh" \
                                          --wait
  test_vision:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Vision on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Vision-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_vision.sh && ./.github/workflow_scripts/test_vision.sh" \
                                          --wait
      - name: Test Vision on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Vision-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_vision.sh && ./.github/workflow_scripts/test_vision.sh" \
                                          --wait
  test_forecasting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Forecasting on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Forecasting-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_forecasting.sh && ./.github/workflow_scripts/test_forecasting.sh" \
                                          --wait
      - name: Test Forecasting on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-GPU \
                                          --name AutoGluon-Forecasting-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_forecasting.sh && ./.github/workflow_scripts/test_forecasting.sh" \
                                          --wait
  test_install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AUTOGLUON_BATCH_ACCESS_ID }}
          aws-secret-access-key: ${{ secrets.AUTOGLUON_BATCH_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Install dependencies
        run: |
          pip install --upgrade --force-reinstall --no-deps .
          pip install boto3
      - name: Test Install on AWS Batch(For push)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Install-${{ github.ref }} \
                                          --source-ref ${{ github.ref }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.repository }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_install.sh && ./.github/workflow_scripts/test_install.sh" \
                                          --wait
      - name: Test Install on AWS Batch(For pull request)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          echo "Start submitting job"
          python ./CI/batch/submit-job.py --region us-east-1 \
                                          --job-type CI-CPU \
                                          --name AutoGluon-Install-PR#${{ github.event.number }} \
                                          --source-ref ${{ github.event.pull_request.head.sha }} \
                                          --work-dir . \
                                          --remote https://github.com/${{ github.event.pull_request.head.repo.full_name }} \
                                          --command "chmod +x ./.github/workflow_scripts/test_install.sh && ./.github/workflow_scripts/test_install.sh" \
                                          --wait